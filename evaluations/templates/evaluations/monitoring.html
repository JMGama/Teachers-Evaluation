<!DOCTYPE html>
<html>

<head>
  {% load static %}
  <!--Materialize things-->

  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="{% static 'evaluations/css/materialize.min.css' %}" media="screen,projection" />
  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="shortcut icon" type="image/x-icon" href="{% static 'evaluations/images/icono.ico' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'evaluations/css/nav_bar.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'evaluations/css/home/style.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'evaluations/css/monitoring/style.css' %}" />

  <!-- Import Chart.js for graphics -->
  <script type="text/javascript" src="{% static 'chart.js/dist/Chart.js' %}"></script>

  <title>Menu Principal</title>

</head>

<body>
  {% include "evaluations/nav_bar_monitoring.html" %}

  <main class="content ">
    <!-- Modal Structure -->
    <div id="modal1" class="modal">
      <div class="modal-content center-align">
        <div class="row ">
          <div class="preloader-wrapper big active">
            <div class="spinner-layer spinner-blue-only">
              <div class="circle-clipper left">
                <div class="circle"></div>
              </div>
              <div class="gap-patch">
                <div class="circle"></div>
              </div>
              <div class="circle-clipper right">
                <div class="circle"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer ">
          <h5>Cargando</h5>
        </div>
      </div>
    </div>


    <div class="row valign-wrapper ">
      <div class="col m10 s12 offset-m1 valign ">
        <div class="card z-depth-4 hoverable ">
          <div class="card-content ">
            <!-- Card to print message -->
            {% if not message is defined %}
            <div class="row " id="alert_box ">
              <div class="col s12 m12 ">
                <div class="card {{ message.1 }} darken-1 ">
                  <div class="row ">
                    <div class="col s12 m10 ">
                      <div class="card-content white-text ">
                        <p>{{ message.0 }}</p>
                      </div>
                    </div>
                    <div class="col s12 m2 ">
                      <i class="fa fa-times icon_style " id="alert_close " aria-hidden="true "></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <div class="row valign-wrapper ">
              <div class="col s8 m10 ">
                <span class="card-title ">
                  <b>Resultados Generales de las Evaluaciones</b>
                </span>
                <hr/>
              </div>
              <div class="col s4 m2 ">
                <img class="responsive-img" src="{% static 'evaluations/images/Guerreros.png' %} ">
              </div>
            </div>


            {% for career, values in careers_data.items %}

            <h6 class="header center">{{career.description.capitalize}}</h6>
            <hr style="width:60%;">
            <div class="row">
              <div class="col s12 m12 l12">
                <div class="row">
                  <div class="col s12 m6 l6">
                    <div class="sample-chart-wrapper">
                      <canvas id="myChart{{career.idcareer}}" width="262" height="130" style="width: 241px; height: 120px;"></canvas>
                    </div>
                    <p class="header center">Evaluaciones Realizadas</p>
                  </div>
                  <div class="col s12 m6 l6">
                    <div class="sample-chart-wrapper">
                      <canvas id="myChart{{career.idcareer}}Average" width="262" height="130" style="width: 241px; height: 120px;"></canvas>
                    </div>
                    <p class="header center">Promedio General</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="row center-align">
              <form id="download{{career.idcareer}}" method="post">
                {% csrf_token %}
              <!--  <button type="submit" class="btn-small waves-effect center red lighten-1 " onClick="loading({{career.idcareer}})"><i class="material-icons right">get_app</i>Alumnos faltantes</button> -->
                <button type="submit" class="btn-small waves-effect center red lighten-1 " onClick="loading1({{career.idcareer}})"><i class="material-icons right">get_app</i>Datos en Exel</button>
                <input type="hidden" name="action" value="excel"/>
                <input type="hidden" name="career" value="{{career.idcareer}}"/>
              </form>

            </div>
            {% endfor %}
            <div class="row center-align">
              <a class="btn-small waves-effect center red lighten-1 " target="_blank"  href="{% url 'evaluations:tech_report' %}"><i class="material-icons right">get_app</i>Reporte Docentes<a>
            </div>


          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- jQuery Library -->
  <script type="text/javascript " src="{% static 'evaluations/js/jquery-1.11.2.min.js' %} "></script>
  <!--JavaScript at end of body for optimized loading-->
  <script type="text/javascript " src="{% static 'evaluations/js/materialize.min.js' %} "></script>
  <script type="text/javascript " src="{% static 'evaluations/js/nav_bar.js' %} "></script>

</body>

<script type="text/javascript ">

  $(document).ready(function(){
    $('.modal').modal({dismissible:false});
  });

  function loading(idCareer){
    $('#modal1').modal('open');
    var csrftoken = $('#download'+idCareer).find('input[name="csrfmiddlewaretoken"]').val();
    var action = $('#download'+idCareer).find('input[name="action"]').val();
    var career = $('#download'+idCareer).find('input[name="career"]').val();
    $.ajax({
      type:"POST",
      url:"{% url 'evaluations:monitoring' %}",
      data: {
            'action': action,
            'career': career,
            'csrfmiddlewaretoken': csrftoken,
            },
      success: function(){
        $('#modal1').modal('close');
      },
      complete: function(){
        $('#modal1').modal('close');
      },
      error: function(){
        $('#modal1').modal('close');
      }
    });
  }

  function loading1(idCareer){
    $('#modal1').modal('open');
    var csrftoken = $('#download'+idCareer).find('input[name="csrfmiddlewaretoken"]').val();
    var action = $('#download'+idCareer).find('input[name="action"]').val();
    var career = $('#download'+idCareer).find('input[name="career"]').val();
    $.ajax({
      type:"POST",
      url:"{% url 'evaluations:tech_report' %}",
      data: {
            'action': action,
            'career': career,
            'csrfmiddlewaretoken': csrftoken,
            },
      success: function(){
        $('#modal1').modal('close');
      },
      complete: function(){
        $('#modal1').modal('close');
      },
      error: function(){
        $('#modal1').modal('close');
      }
    });
  }
</script>

<script type="text/javascript ">
  Chart.pluginService.register({
    beforeDraw: function (chart) {
      if (chart.config.options.elements.center) {
        //Get ctx from string
        var ctx = chart.chart.ctx;

        //Get options from the center object in options
        var centerConfig = chart.config.options.elements.center;
        var fontStyle = centerConfig.fontStyle || 'Arial';
        var txt = centerConfig.text;
        var color = centerConfig.color || '#000';
        var sidePadding = centerConfig.sidePadding || 20;
        var sidePaddingCalculated = (sidePadding/100) * (chart.innerRadius * 2)
        //Start with a base font of 30px
        ctx.font = "30px " + fontStyle;

        //Get the width of the string and also the width of the element minus 10 to give it 5px side padding
        var stringWidth = ctx.measureText(txt).width;
        var elementWidth = (chart.innerRadius * 2) - sidePaddingCalculated;

        // Find out how much the font can grow in width.
        var widthRatio = elementWidth / stringWidth;
        var newFontSize = Math.floor(30 * widthRatio);
        var elementHeight = (chart.innerRadius * 2);

        // Pick a new font size so it will not be larger than the height of label.
        var fontSizeToUse = Math.min(newFontSize, elementHeight);

        //Set font settings to draw it correctly.
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        var centerX = ((chart.chartArea.left + chart.chartArea.right) / 2);
        var centerY = ((chart.chartArea.top + chart.chartArea.bottom) / 2);
        ctx.font = fontSizeToUse+"px " + fontStyle;
        ctx.fillStyle = color;

        //Draw text in center
        ctx.fillText(txt, centerX, centerY);
      }
    }
  });
</script>

<script type="text/javascript ">
  {% for career, values in careers_data.items %}
    var ctx = document.getElementById("myChart{{career.idcareer}}").getContext('2d');
    var evaluated = {{values.evaluated|length}};
    var not_evaluated = {{values.not_evaluated|length}};
    var percentage = (evaluated / (not_evaluated + evaluated) * 100).toFixed(0) + "%";
    var data = {
      labels: ["Realizadas ", "Faltantes "],
      datasets: [{
        data: [{{values.evaluated|length}},{{values.not_evaluated|length}}],
        backgroundColor: [
          '#21da7d',
          '#f7464a',
        ],
        borderColor: [
          'rgb(255, 255, 255)',
          'rgb(255, 255, 255)',
        ],
        borderWidth: 3
      }]
    }
    var options = {
      legend: {
        display: false
      },
      elements: {
				center: {
					text: percentage, // Porcentaje de alumnos
          color: 'black', // Default is #000000
          fontStyle: 'Arial', // Default is Arial
          sidePadding: 20 // Defualt is 20 (as a percentage)
				}
			}
    }
    var myDoughnutChart = new Chart(ctx, {
      type: 'doughnut',
      data: data,
      options: options
    });
  {% endfor %}
</script>

<script type="text/javascript ">
  {% for career, values in careers_data.items %}
    var ctx = document.getElementById("myChart{{career.idcareer}}Average").getContext('2d');
    var data = {
      labels: ["Si ", "No "],
      datasets: [{
        data: [{{values.average_data.yes}}, {{values.average_data.no}}],
        backgroundColor: [
          '#21da7d',
          '#f7464a',
        ],
        borderColor: [
          'rgb(255, 255, 255)',
          'rgb(255, 255, 255)',
        ],
        borderWidth: 3
      }]
    }
    var options = {
      legend: {
        display: false
      },
      elements: {
        center: {
          text: {{values.average_data.average}}.toFixed(0) + "%", // Porcentaje de alumnos
          color: 'black', // Default is #000000
          fontStyle: 'Arial', // Default is Arial
          sidePadding: 20 // Defualt is 20 (as a percentage)
        }
      }
    }
    var myDoughnutChart = new Chart(ctx, {
      type: 'doughnut',
      data: data,
      options: options
    });
  {% endfor %}
</script>

</html>
